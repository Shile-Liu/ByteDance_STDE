<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI æ™ºèƒ½æµ‹è¯•ç”¨ä¾‹ç”Ÿæˆå¹³å°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        /* Markdown è¡¨æ ¼æ ·å¼ä¼˜åŒ– */
        .markdown-body table { width: 100%; border-collapse: collapse; margin: 1rem 0; font-size: 0.9rem; }
        .markdown-body th, .markdown-body td { border: 1px solid #e2e8f0; padding: 12px; text-align: left; }
        .markdown-body th { background-color: #f1f5f9; font-weight: 600; color: #334155; }
        .markdown-body tr:nth-child(even) { background-color: #f8fafc; }
        .fade-enter-active, .fade-leave-active { transition: opacity 0.5s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
    </style>
</head>
<body class="text-slate-700">

<div id="app" class="min-h-screen flex flex-col items-center py-10 px-4">

    <header class="text-center mb-10">
        <h1 class="text-4xl font-bold text-slate-800 tracking-tight mb-2">
            <span class="bg-clip-text text-transparent bg-gradient-to-r from-blue-600 to-indigo-600">
                AI æµ‹è¯•ç”¨ä¾‹æ™ºæˆç³»ç»Ÿ
            </span>
        </h1>
        <p class="text-slate-500">åŸºäºå¤§æ¨¡å‹ä» PRD è‡ªåŠ¨ç”Ÿæˆå¹¶è¯„ä¼°æµ‹è¯•ç”¨ä¾‹</p>
    </header>

    <div class="w-full max-w-5xl mb-6 p-4 bg-yellow-50 border border-yellow-200 rounded-lg text-sm text-yellow-800 flex flex-col gap-2">
        <p class="font-bold">âš ï¸ ç³»ç»Ÿé…ç½® (è¯·åœ¨æ­¤å¤„å¡«å…¥ä½ çš„ Coze ä¿¡æ¯)</p>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
            <input v-model="cozeConfig.token" type="password" placeholder="Coze PAT (Personal Access Token)" class="p-2 border rounded">
            <input v-model="cozeConfig.botIdGen" type="text" placeholder="ç”Ÿæˆç”¨ä¾‹ Bot ID" class="p-2 border rounded">
            <input v-model="cozeConfig.botIdEval" type="text" placeholder="è¯„æµ‹ Bot ID" class="p-2 border rounded">
        </div>
    </div>

    <main class="w-full max-w-5xl space-y-8">
        
        <section class="glass-card shadow-xl rounded-2xl overflow-hidden">
            <div class="bg-slate-50 border-b border-slate-100 p-4 flex gap-4">
                <button @click="inputType = 'text'" :class="{'bg-white shadow text-blue-600': inputType === 'text', 'text-slate-500 hover:text-slate-700': inputType !== 'text'}" class="px-4 py-2 rounded-lg transition-all font-medium text-sm">ğŸ“„ æ–‡æœ¬ç²˜è´´</button>
                <button @click="inputType = 'link'" :class="{'bg-white shadow text-blue-600': inputType === 'link', 'text-slate-500 hover:text-slate-700': inputType !== 'link'}" class="px-4 py-2 rounded-lg transition-all font-medium text-sm">ğŸ”— æ–‡æ¡£é“¾æ¥</button>
                <button @click="inputType = 'image'" :class="{'bg-white shadow text-blue-600': inputType === 'image', 'text-slate-500 hover:text-slate-700': inputType !== 'image'}" class="px-4 py-2 rounded-lg transition-all font-medium text-sm">ğŸ–¼ï¸ å›¾ç‰‡ä¸Šä¼ </button>
            </div>

            <div class="p-6">
                <div v-if="inputType === 'text'">
                    <textarea v-model="prdContent" class="w-full h-48 p-4 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:outline-none transition resize-none" placeholder="è¯·åœ¨æ­¤å¤„ç²˜è´´äº§å“éœ€æ±‚æ–‡æ¡£ (PRD) çš„è¯¦ç»†å†…å®¹..."></textarea>
                </div>

                <div v-if="inputType === 'link'">
                    <div class="flex gap-2">
                        <input v-model="prdLink" type="text" class="flex-1 p-4 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="è¯·è¾“å…¥é£ä¹¦æ–‡æ¡£é“¾æ¥...">
                    </div>
                    <p class="mt-2 text-xs text-slate-400">* éœ€è¦ Bot é…ç½®é£ä¹¦æ’ä»¶æƒé™</p>
                </div>

                <div v-if="inputType === 'image'" class="border-2 border-dashed border-slate-300 rounded-xl h-48 flex flex-col items-center justify-center bg-slate-50 hover:bg-slate-100 transition cursor-pointer relative">
                    <input type="file" @change="handleImageUpload" accept="image/*" class="absolute inset-0 opacity-0 cursor-pointer">
                    
                    <div class="text-center" v-if="!uploadedImageName">
                        <span class="text-4xl">ğŸ“¤</span>
                        <p class="mt-2 text-sm text-slate-500">ç‚¹å‡»ä¸Šä¼  PRD æˆªå›¾æˆ– UI è®¾è®¡å›¾</p>
                    </div>

                    <div v-else-if="isUploadingImg" class="text-center text-blue-600">
                        <span class="text-2xl animate-spin block mb-2">â³</span>
                        <p class="font-medium">æ­£åœ¨ä¸Šä¼ åˆ° AI æœåŠ¡å™¨...</p>
                    </div>

                    <div v-else class="text-center text-emerald-600 font-medium">
                        <span class="text-4xl block mb-2">âœ…</span>
                        å·²å°±ç»ª: {{ uploadedImageName }}
                    </div>
                </div>

                <div class="mt-6 flex justify-end">
                    <button @click="generateCases" :disabled="isLoadingGen" class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white px-8 py-3 rounded-xl font-semibold shadow-lg shadow-blue-500/30 hover:shadow-blue-500/40 transform hover:-translate-y-0.5 transition-all disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2">
                        <span v-if="isLoadingGen" class="animate-spin text-xl">â³</span>
                        {{ isLoadingGen ? 'AI æ­£åœ¨åˆ†æéœ€æ±‚...' : 'âœ¨ ç”Ÿæˆæµ‹è¯•ç”¨ä¾‹' }}
                    </button>
                </div>
            </div>
        </section>

        <section v-if="generatedResult" class="glass-card shadow-xl rounded-2xl overflow-hidden animate-fade-in">
            <div class="bg-indigo-50 border-b border-indigo-100 p-4 flex justify-between items-center">
                <h2 class="font-bold text-indigo-900 flex items-center gap-2">ğŸ¤– AI ç”Ÿæˆç»“æœ</h2>
                <span class="text-xs bg-indigo-200 text-indigo-800 px-2 py-1 rounded">Markdown/è¡¨æ ¼è§†å›¾</span>
            </div>
            <div class="p-6 overflow-x-auto">
                <div class="markdown-body text-slate-600 leading-relaxed" v-html="parsedGeneratedResult"></div>
            </div>
        </section>

        <section class="glass-card shadow-xl rounded-2xl overflow-hidden">
            <div class="bg-emerald-50 border-b border-emerald-100 p-4">
                <h2 class="font-bold text-emerald-900">âš–ï¸ æ•ˆæœè¯„æµ‹ (Human vs AI)</h2>
            </div>
            <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-8">
                
                <div class="space-y-4">
                    <label class="block text-sm font-medium text-slate-700">æ­¥éª¤ 1: è¾“å…¥äººå·¥ç¼–å†™çš„æ ‡å‡†ç”¨ä¾‹</label>
                    <textarea v-model="manualCases" class="w-full h-64 p-4 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-emerald-500 focus:outline-none transition resize-none text-sm font-mono" placeholder='è¯·æŒ‰æ ‡å‡†æ ¼å¼ç²˜è´´äººå·¥æµ‹è¯•ç”¨ä¾‹ï¼Œä¾‹å¦‚ï¼š
1. æ ‡é¢˜ï¼šç™»å½•æˆåŠŸ
   å‰ç½®æ¡ä»¶ï¼šå·²æ³¨å†Œ
   æ­¥éª¤ï¼šè¾“å…¥è´¦å·å¯†ç  -> ç‚¹å‡»ç™»å½•
   é¢„æœŸï¼šè·³è½¬é¦–é¡µ'></textarea>
                    <button @click="startEvaluation" :disabled="!generatedResult || !manualCases || isLoadingEval" class="w-full bg-emerald-600 text-white px-6 py-3 rounded-xl font-semibold shadow-lg shadow-emerald-500/30 hover:shadow-emerald-500/40 transition-all disabled:opacity-50 disabled:cursor-not-allowed">
                        {{ isLoadingEval ? 'æ­£åœ¨è®¡ç®—æŒ‡æ ‡...' : 'ğŸ“Š å¼€å§‹å¯¹æ¯”è¯„æµ‹' }}
                    </button>
                    <p v-if="!generatedResult" class="text-xs text-red-400 text-center">è¯·å…ˆç”Ÿæˆ AI ç”¨ä¾‹æ‰èƒ½è¿›è¡Œå¯¹æ¯”</p>
                </div>

                <div class="bg-slate-50 rounded-xl border border-slate-200 p-6 flex flex-col items-center justify-center min-h-[300px]">
                    <div v-if="!evaluationResult" class="text-center text-slate-400">
                        <span class="text-4xl block mb-2">ğŸ“ˆ</span>
                        ç­‰å¾…è¯„æµ‹æ•°æ®...
                    </div>
                    
                    <div v-else class="w-full space-y-4">
                        <h3 class="font-bold text-slate-800 border-b pb-2">è¯„æµ‹æŠ¥å‘Š</h3>
                        <div class="markdown-body text-sm" v-html="parsedEvaluationResult"></div>
                    </div>
                </div>
            </div>
        </section>

    </main>

    <footer class="mt-12 text-slate-400 text-sm">
        Â© 2025 Course Assignment Demo | Powered by Coze & Vue 3
    </footer>

</div>

<script>
    const { createApp, ref, computed } = Vue;

    createApp({
        setup() {
            // ================= é…ç½®åŒºåŸŸ =================
            const cozeConfig = ref({
                token: '', // ä½ çš„ Coze PAT
                botIdGen: '', // ç”Ÿæˆç”¨ä¾‹ Bot ID
                botIdEval: '' // è¯„æµ‹ Bot ID
            });

            // ================= çŠ¶æ€å˜é‡ =================
            const inputType = ref('text'); 
            const prdContent = ref('');
            const prdLink = ref('');
            
            // å›¾ç‰‡ç›¸å…³çŠ¶æ€
            const uploadedImageName = ref('');
            const uploadedFileId = ref(''); // æ–°å¢ï¼šç”¨äºå­˜å‚¨ Coze è¿”å›çš„æ–‡ä»¶ ID
            const isUploadingImg = ref(false);

            const manualCases = ref('');
            const generatedResult = ref('');
            const evaluationResult = ref('');
            const isLoadingGen = ref(false);
            const isLoadingEval = ref(false);

            // ================= æ ¸å¿ƒé€»è¾‘ï¼šæ–‡ä»¶ä¸Šä¼  =================
            // çœŸæ­£å°†æ–‡ä»¶ä¸Šä¼ åˆ° Coze
            const uploadFileToCoze = async (file) => {
                if (!cozeConfig.value.token) {
                    alert("è¯·å…ˆå¡«å†™ Coze Token");
                    return null;
                }
                
                const formData = new FormData();
                formData.append('file', file);

                try {
                    const response = await fetch('https://api.coze.cn/v1/files/upload', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${cozeConfig.value.token}`
                            // æ³¨æ„ï¼šFetch ä¼šè‡ªåŠ¨è®¾ç½® Content-Type ä¸º multipart/form-dataï¼Œä¸è¦æ‰‹åŠ¨è®¾ç½®
                        },
                        body: formData
                    });

                    const data = await response.json();
                    if (data.code === 0) {
                        return data.data.id; // è¿”å› file_id
                    } else {
                        throw new Error(data.msg);
                    }
                } catch (e) {
                    console.error("ä¸Šä¼ å¤±è´¥", e);
                    alert(`å›¾ç‰‡ä¸Šä¼ å¤±è´¥: ${e.message} \n(è¯·æ£€æŸ¥æ˜¯å¦å¼€å¯äº† CORS æ’ä»¶)`);
                    return null;
                }
            };

            // å¤„ç†ç”¨æˆ·é€‰æ‹©å›¾ç‰‡
            const handleImageUpload = async (event) => {
                const file = event.target.files[0];
                if (!file) return;

                uploadedImageName.value = file.name;
                isUploadingImg.value = true; // æ˜¾ç¤ºä¸Šä¼ ä¸­çŠ¶æ€

                // æ‰§è¡Œä¸Šä¼ 
                const fileId = await uploadFileToCoze(file);
                
                if (fileId) {
                    uploadedFileId.value = fileId;
                    console.log("å›¾ç‰‡å·²ä¸Šä¼ è‡³ Coze, ID:", fileId);
                } else {
                    uploadedImageName.value = ''; // ä¸Šä¼ å¤±è´¥é‡ç½®
                }
                isUploadingImg.value = false;
            };

            // ================= æ ¸å¿ƒé€»è¾‘ï¼šAPI è°ƒç”¨ =================
            
            // è½®è¯¢è·å–å›å¤ (ä¿æŒä¸å˜ï¼Œç”¨äºç­‰å¾…é•¿æ–‡æœ¬ç”Ÿæˆ)
            const pollCozeResponse = async (chatId, conversationId) => {
                const retrieveUrl = `https://api.coze.cn/v3/chat/retrieve?chat_id=${chatId}&conversation_id=${conversationId}`;
                const messageListUrl = `https://api.coze.cn/v3/chat/message/list?chat_id=${chatId}&conversation_id=${conversationId}`;
                
                let status = 'in_progress';
                let attempts = 0;
                const maxAttempts = 60; 

                while (status === 'in_progress' && attempts < maxAttempts) {
                    attempts++;
                    await new Promise(r => setTimeout(r, 2000));

                    try {
                        const statusRes = await fetch(retrieveUrl, {
                            method: 'GET',
                            headers: { 'Authorization': `Bearer ${cozeConfig.value.token}` }
                        });
                        const statusData = await statusRes.json();
                        
                        if (statusData.data) {
                            status = statusData.data.status;
                            if (status === 'completed') {
                                const msgRes = await fetch(messageListUrl, {
                                    method: 'GET',
                                    headers: { 'Authorization': `Bearer ${cozeConfig.value.token}` }
                                });
                                const msgData = await msgRes.json();
                                if (msgData.data) {
                                    const answerMsg = msgData.data.find(m => m.role === 'assistant' && m.type === 'answer');
                                    return answerMsg ? answerMsg.content : "AI æœªè¿”å›å†…å®¹";
                                }
                            } else if (status === 'failed') {
                                return `âŒ ç”Ÿæˆå¤±è´¥: ${statusData.data.last_error?.msg || 'æœªçŸ¥é”™è¯¯'}`;
                            }
                        }
                    } catch (e) { console.error(e); }
                }
                return "â° ç”Ÿæˆè¶…æ—¶";
            };

            // é€šç”¨ API è°ƒç”¨ (å·²å‡çº§æ”¯æŒå¤šæ¨¡æ€å›¾ç‰‡)
            const callCozeBot = async (botId, textMessage, fileId = null) => {
                if (!cozeConfig.value.token || !botId) throw new Error("è¯·å…ˆå¡«å†™é…ç½®ä¿¡æ¯");

                const url = 'https://api.coze.cn/v3/chat'; 
                
                // æ„é€ æ¶ˆæ¯ä½“
                let messageObject = {
                    role: 'user',
                    content: textMessage,
                    content_type: 'text'
                };

                // å¦‚æœæœ‰å›¾ç‰‡ï¼Œæ„é€ å¤šæ¨¡æ€æ¶ˆæ¯ (Object String)
                if (fileId) {
                    const multiModalContent = [
                        { type: "text", text: textMessage },
                        { type: "image", file_id: fileId }
                    ];
                    messageObject = {
                        role: 'user',
                        content: JSON.stringify(multiModalContent),
                        content_type: 'object_string' // å…³é”®ï¼šå‘Šè¯‰ Coze è¿™æ˜¯ä¸€ä¸ªåŒ…å«å›¾ç‰‡çš„å¯¹è±¡
                    };
                }

                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${cozeConfig.value.token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        bot_id: botId,
                        user_id: 'user_' + Date.now(),
                        stream: false, 
                        auto_save_history: true,
                        additional_messages: [ messageObject ]
                    })
                });

                const data = await response.json();
                if (data.code === 0 && data.data) {
                    return await pollCozeResponse(data.data.id, data.data.conversation_id);
                }
                throw new Error(data.msg || 'è¯·æ±‚å¤±è´¥');
            };

            // ================= ä¸šåŠ¡è§¦å‘å‡½æ•° =================

            const generateCases = async () => {
                // æ ¡éªŒè¾“å…¥
                if (inputType.value === 'text' && !prdContent.value) return alert('è¯·è¾“å…¥æ–‡æœ¬');
                if (inputType.value === 'link' && !prdLink.value) return alert('è¯·è¾“å…¥é“¾æ¥');
                if (inputType.value === 'image' && !uploadedFileId.value) return alert('è¯·å…ˆä¸Šä¼ å›¾ç‰‡å¹¶ç­‰å¾…ä¸Šä¼ å®Œæˆ');

                isLoadingGen.value = true;
                generatedResult.value = 'â³ AI æ­£åœ¨åˆ†æéœ€æ±‚å¹¶ç”Ÿæˆæµ‹è¯•ç”¨ä¾‹...';

                try {
                    let prompt = "è¯·æ ¹æ®æä¾›çš„å†…å®¹ç”Ÿæˆè¯¦ç»†çš„æµ‹è¯•ç”¨ä¾‹ã€‚";
                    let fileId = null;

                    if (inputType.value === 'text') prompt = `PRDå†…å®¹å¦‚ä¸‹ï¼š\n${prdContent.value}`;
                    if (inputType.value === 'link') prompt = `è¯·é˜…è¯»æ­¤é“¾æ¥ï¼š${prdLink.value}`;
                    if (inputType.value === 'image') {
                        prompt = "è¯·ä»”ç»†åˆ†æè¿™å¼ å›¾ç‰‡ï¼ˆUIè®¾è®¡å›¾æˆ–éœ€æ±‚æˆªå›¾ï¼‰ï¼Œæå–æ‰€æœ‰çš„åŠŸèƒ½ç‚¹ï¼Œå¹¶ç”Ÿæˆå¯¹åº”çš„æµ‹è¯•ç”¨ä¾‹è¡¨æ ¼ã€‚";
                        fileId = uploadedFileId.value; // ä¼ å…¥ä¸Šä¼ æˆåŠŸçš„æ–‡ä»¶ ID
                    }

                    const result = await callCozeBot(cozeConfig.value.botIdGen, prompt, fileId);
                    generatedResult.value = result;
                } catch (e) {
                    generatedResult.value = `âŒ é”™è¯¯: ${e.message}`;
                } finally {
                    isLoadingGen.value = false;
                }
            };

            const startEvaluation = async () => {
                if (!generatedResult.value || !manualCases.value) return;
                isLoadingEval.value = true;
                evaluationResult.value = 'â³ æ­£åœ¨è¿›è¡Œå¯¹æ¯”è¯„æµ‹...';
                try {
                    const prompt = `è¯·å¯¹æ¯”ä»¥ä¸‹ä¸¤ä»½æµ‹è¯•ç”¨ä¾‹ï¼š\n\nã€AIç”Ÿæˆã€‘:\n${generatedResult.value}\n\nã€äººå·¥ç¼–å†™ã€‘:\n${manualCases.value}`;
                    const result = await callCozeBot(cozeConfig.value.botIdEval, prompt);
                    evaluationResult.value = result;
                } catch (e) {
                    evaluationResult.value = `âŒ è¯„æµ‹å¤±è´¥: ${e.message}`;
                } finally {
                    isLoadingEval.value = false;
                }
            };

            // Markdown è§£æ
            const parsedGeneratedResult = computed(() => generatedResult.value ? marked.parse(generatedResult.value) : '');
            const parsedEvaluationResult = computed(() => evaluationResult.value ? marked.parse(evaluationResult.value) : '');

            return {
                cozeConfig, inputType, prdContent, prdLink, 
                uploadedImageName, isUploadingImg, manualCases, 
                generatedResult, evaluationResult, 
                parsedGeneratedResult, parsedEvaluationResult,
                isLoadingGen, isLoadingEval,
                handleImageUpload, generateCases, startEvaluation
            };
        }
    }).mount('#app');
</script>

<style>
/* ç®€å•çš„åŠ¨ç”»æ•ˆæœ */
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}
.animate-fade-in {
    animation: fadeIn 0.5s ease-out forwards;
}
</style>
</body>
</html>